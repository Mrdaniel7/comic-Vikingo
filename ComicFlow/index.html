<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComicFlow Creator Ultimate</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --primary: #bb86fc;
            --primary-variant: #3700b3;
            --secondary: #03dac6;
            --text-main: #ffffff;
            --text-dim: #b0b0b0;
            --danger: #cf6679;
            --border: #333;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            height: 50px;
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            z-index: 50;
        }

        .brand { font-weight: bold; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .version-tag { font-size: 0.7rem; background: #333; padding: 2px 5px; border-radius: 4px; color: #aaa; }
        
        .nav-tabs button {
            background: none;
            border: none;
            color: var(--text-dim);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 2px solid transparent;
            transition: 0.2s;
        }

        .nav-tabs button.active {
            color: var(--text-main);
            border-bottom: 2px solid var(--primary);
        }

        .actions button {
            background-color: #333;
            color: white;
            border: 1px solid #555;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
            transition: all 0.2s;
        }
        
        .actions button.primary { background-color: var(--primary-variant); border-color: var(--primary-variant); }
        .actions button.danger { background-color: transparent; border-color: var(--danger); color: var(--danger); }
        .actions button.optimize-btn { background-color: rgba(3, 218, 198, 0.1); border-color: var(--secondary); color: var(--secondary); }
        .actions button:hover { opacity: 0.9; transform: translateY(-1px); }

        /* --- LAYOUT PRINCIPAL --- */
        #app-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
        }

        /* --- VISTA EDITOR --- */
        #editor-view {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* COLUMNA 1: LISTA DE ESCENAS */
        .sidebar {
            width: 260px;
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            flex-shrink: 0;
        }

        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); }
        .scene-list { flex: 1; overflow-y: auto; padding: 10px; }

        .scene-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #2a2a2a;
            margin-bottom: 6px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: background 0.2s;
            position: relative;
        }

        .scene-item:hover { background: #333; }
        .scene-item.active { border-color: var(--primary); background: #333; }
        
        .scene-index {
            font-size: 1.2rem;
            font-weight: bold;
            color: #555;
            width: 30px;
            text-align: center;
            margin-right: 5px;
            font-variant-numeric: tabular-nums;
        }
        .scene-item.active .scene-index { color: var(--primary); }

        .scene-thumb { width: 36px; height: 36px; object-fit: cover; border-radius: 4px; margin-right: 10px; background: #000; }
        .scene-info { flex: 1; overflow: hidden; }
        .scene-name { font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .scene-badges { display: flex; gap: 4px; margin-top: 2px; }
        .badge { font-size: 0.65rem; padding: 1px 4px; border-radius: 2px; background: #444; }
        .badge.start { background: var(--secondary); color: #000; }

        /* COLUMNA 2: CANVAS DE EDICI√ìN */
        .work-area {
            flex: 1;
            background-color: #0c0c0c;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .canvas-toolbar {
            height: 44px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
            border-bottom: 1px solid #333;
        }

        .tool-group { display: flex; gap: 2px; background: #252525; padding: 2px; border-radius: 4px; }
        .tool-btn {
            background: transparent; border: none; color: #aaa;
            padding: 5px 10px; cursor: pointer; border-radius: 3px;
            display: flex; align-items: center; gap: 6px; font-size: 0.85rem;
            white-space: nowrap;
        }
        .tool-btn:hover { background: #333; color: white; }
        .tool-btn.active { background: #444; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        .canvas-viewport {
            flex: 1; display: flex; justify-content: center; align-items: center;
            overflow: hidden; position: relative;
            background-image: radial-gradient(#2a2a2a 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .canvas-viewport[data-mode="draw"] { cursor: crosshair; }
        .canvas-viewport[data-mode="pan"] { cursor: grab; }
        .canvas-viewport[data-mode="pan"]:active { cursor: grabbing; }

        #interactive-wrapper {
            position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.5);
            width: auto; height: auto;
            max-width: 95%; max-height: 85vh; 
            line-height: 0; 
            transition: transform 0.1s;
        }

        #editor-img { 
            display: block; 
            width: auto; height: auto;
            max-width: 100%; max-height: 85vh; 
            user-select: none; pointer-events: none; 
            object-fit: contain;
        }

        /* Zonas */
        .zone {
            position: absolute; border: 2px solid var(--primary);
            background-color: rgba(187, 134, 252, 0.15);
            cursor: move; display: flex; align-items: center; justify-content: center;
            z-index: 10;
        }
        .zone:hover { background-color: rgba(187, 134, 252, 0.3); border-color: #fff; }

        .zone.is-invisible {
            border: 2px dashed #777;
            background-color: rgba(100, 100, 100, 0.1);
        }
        .zone.is-invisible .zone-label {
            background: rgba(50, 50, 50, 0.8);
            color: #ccc;
        }
        .zone.is-invisible:hover {
            border-color: #aaa;
            background-color: rgba(100, 100, 100, 0.2);
        }
        
        .zone-ctrl-btn {
            position: absolute; top: -10px;
            border-radius: 50%; width: 20px; height: 20px;
            text-align: center; line-height: 18px; font-size: 12px;
            cursor: pointer; display: none; z-index: 20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            color: white; font-weight: bold;
        }
        
        .zone-delete { right: -10px; background: var(--danger); }
        .zone-edit { right: 15px; background: #2196F3; } 
        
        .zone:hover .zone-ctrl-btn { display: block; }
        
        .zone-resize {
            position: absolute; bottom: 0; right: 0;
            width: 15px; height: 15px;
            background: linear-gradient(135deg, transparent 50%, var(--primary) 50%);
            cursor: se-resize;
            z-index: 25;
        }
        .zone-resize:hover { transform: scale(1.1); filter: brightness(1.2); }

        .zone-branch-tag {
            position: absolute; top: -10px; left: -10px;
            background: var(--secondary); color: #000;
            width: 20px; height: 20px; border-radius: 50%;
            font-weight: bold; font-size: 11px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .zone-label {
            font-size: 11px; background: rgba(0,0,0,0.8);
            padding: 3px 6px; border-radius: 3px;
            pointer-events: none; color: #fff;
            max-width: 95%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            line-height: normal;
        }

        #draw-box {
            position: absolute; border: 2px dashed var(--secondary);
            background: rgba(3, 218, 198, 0.1);
            pointer-events: none; display: none; z-index: 20;
        }

        /* --- COLUMNA 3: MAPA DE NODOS --- */
        .node-map-panel {
            width: 300px;
            background-color: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: width 0.3s ease;
            z-index: 20;
        }
        
        #app-container.map-expanded .sidebar { display: none; }
        #app-container.map-expanded .work-area { display: none; }
        #app-container.map-expanded .node-map-panel { width: 100%; border-left: none; }
        #app-container.map-expanded .map-expand-btn { background: var(--primary); color: white; }

        .map-toolbar {
            padding: 8px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.8rem; background: #222;
        }
        #node-canvas { width: 100%; height: 100%; background: #151515; cursor: grab; }
        #node-canvas:active { cursor: grabbing; }

        /* MENU CONTEXTUAL */
        .context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 1000;
            min-width: 150px;
            padding: 5px 0;
        }
        .context-menu-item {
            padding: 8px 15px;
            color: #ddd;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        .context-menu-item:hover { background: var(--primary-variant); color: white; }
        .context-menu-separator { height: 1px; background: #444; margin: 4px 0; }
        .context-menu-item.danger:hover { background: var(--danger); }

        /* --- VISTA JUGADOR / PREVIEW --- */
        #player-view {
            position: fixed; 
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000;
            display: flex; justify-content: center; align-items: center;
            z-index: 2000;
            overflow: hidden;
        }

        #player-wrapper { 
            position: relative; 
            width: auto; height: auto;
            max-width: 100%; max-height: 100%;
            line-height: 0;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        #player-img { 
            display: block; 
            width: auto; height: auto;
            max-width: 100vw; max-height: 100vh; 
            object-fit: contain; 
        }
        
        .nav-overlay {
            position: absolute; z-index: 2002; display: flex; align-items: center; justify-content: center;
            cursor: pointer; user-select: none; transition: opacity 0.5s, transform 0.2s;
        }
        .nav-overlay:hover { transform: scale(1.1); }
        .nav-overlay.hidden-ui { opacity: 0; pointer-events: none; }
        
        .nav-btn-classic { background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 50%; width: 50px; height: 50px; color: white; font-size: 20px; }
        .nav-btn-minimal { background: transparent; color: rgba(255,255,255,0.7); font-size: 40px; text-shadow: 0 0 5px black; }
        .nav-btn-comic { background: white; border: 3px solid black; color: black; font-family: 'Comic Sans MS', cursive; border-radius: 10px; padding: 10px; font-weight: bold; box-shadow: 3px 3px 0 black; }
        
        .play-zone { position: absolute; cursor: pointer; z-index: 2001; }
        .play-zone:active { background-color: rgba(255, 255, 255, 0.2); }

        .hidden { display: none !important; }

        /* MODALES */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.75); display: flex; justify-content: center; align-items: center;
            z-index: 3000; backdrop-filter: blur(2px);
        }
        .modal {
            background: #222; padding: 25px; border-radius: 8px; width: 400px;
            border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.7);
        }
        .modal h3 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px;}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #aaa; margin-bottom: 5px; font-size: 0.9rem; }
        .form-group select, .form-group input { width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #444; border-radius: 4px; }
        .form-row { display: flex; gap: 15px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; pt: 15px; border-top: 1px solid #333; }
        .btn-cancel { background: transparent; border: 1px solid #555; color: #ccc; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .btn-confirm { background: var(--primary); border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .btn-danger { background: var(--danger); }

        .map-hint { position: absolute; bottom: 10px; right: 10px; color: #777; font-size: 0.75rem; pointer-events: none; text-align: right; background:rgba(0,0,0,0.5); padding:5px; border-radius:4px;}
        
        .autolink-option {
            border: 1px solid #444; padding: 10px; margin-bottom: 10px; border-radius: 4px; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .autolink-option:hover, .autolink-option.selected { border-color: var(--primary); background: #333; }
        .autolink-icon { font-size: 1.2rem; }
        .autolink-desc { font-size: 0.8rem; color: #aaa; }

    </style>
</head>
<body>

    <!-- CABECERA -->
    <header>
        <div class="brand">
            <span>ComicFlow</span>
            <span class="version-tag">Ultimate</span>
        </div>
        <div class="nav-tabs">
            <button id="tab-editor" class="active" onclick="switchMode('editor')">Editor</button>
            <button id="tab-player" onclick="switchMode('player')">Previsualizar</button>
        </div>
        <div class="actions">
            <!-- BOT√ìN IMPORTAR -->
            <input type="file" id="import-upload" accept=".html,.json" style="display: none;" onchange="handleProjectImport(this)">
            <button onclick="document.getElementById('import-upload').click()" title="Cargar proyecto desde archivo HTML exportado">üìÇ Importar</button>
            
            <button onclick="openSettings()">‚öôÔ∏è Visor</button>
            <!-- BOTON PARA COMPRIMIR PROYECTOS IMPORTADOS -->
            <button class="optimize-btn" style="background-color: rgba(3, 218, 198, 0.1); border-color: var(--secondary); color: var(--secondary);" onclick="openCompressionModal()" title="Reducir peso">‚ôªÔ∏è Comprimir</button>

            <button class="primary" onclick="exportProject()">Exportar HTML</button>
            <button class="danger" onclick="confirmAction('¬øBorrar todo el proyecto?', clearProject)" title="Borrar todo">üóëÔ∏è</button>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <div id="app-container">

        <!-- MODO EDITOR -->
        <div id="editor-view">
            
            <!-- PANEL IZQUIERDO: ESCENAS -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <input type="file" id="img-upload" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(this)">
                    <button onclick="document.getElementById('img-upload').click()" style="width: 100%; padding: 10px; cursor: pointer; background: var(--secondary); border: none; font-weight: bold; border-radius: 4px; color: #000;">+ A√±adir Im√°genes</button>
                </div>
                <div class="scene-list" id="scene-list-container"></div>
            </aside>

            <!-- PANEL CENTRAL: CANVAS -->
            <main class="work-area">
                <div class="canvas-toolbar">
                    <div class="tool-group">
                        <button id="btn-tool-draw" class="tool-btn active" onclick="setTool('draw')">‚úèÔ∏è Zona</button>
                        <button id="btn-tool-pan" class="tool-btn" onclick="setTool('pan')">‚úã Mover</button>
                    </div>
                    <span id="current-scene-name" style="font-size: 0.9rem; color:#888;">...</span>
                    <!-- Agrupados para dise√±o consistente -->
                    <div class="tool-group">
                        <button onclick="setAsStartScene()" class="tool-btn" title="Empezar historia aqu√≠">üè† Inicio</button>
                        <button onclick="reqClearConnections()" class="tool-btn" style="color:#ff9800;" title="Borrar solo las uniones (flechas) de esta escena">‚úÇÔ∏è Uniones</button>
                        <button onclick="reqDeleteScene()" class="tool-btn" style="color:var(--danger);" title="Borrar Escena completa">üóëÔ∏è Escena</button>
                    </div>
                </div>

                <div class="canvas-viewport" id="viewport" data-mode="draw">
                    <div id="interactive-wrapper">
                        <img id="editor-img" src="" style="display:none;">
                        <div id="draw-box"></div>
                    </div>
                    <div id="empty-state-msg" style="color: #444; text-align: center;">
                        <h3>Sin Escena Seleccionada</h3>
                        <p>Selecciona o sube una imagen a la izquierda.</p>
                    </div>
                </div>
            </main>

            <!-- PANEL DERECHO: MAPA -->
            <aside class="node-map-panel">
                <div class="map-toolbar">
                    <span>Mapa de Historia</span>
                    <div>
                        <button onclick="openAutoLink()" style="background:none; border:none; color:var(--primary); cursor:pointer; font-size:16px; margin-right:5px;" title="Auto-Conectar">‚ö°</button>
                        <button onclick="autoLayout()" style="background:none; border:none; color:#888; cursor:pointer; font-size:16px;" title="Reorganizar nodos">‚Ü∫</button>
                        <button class="map-expand-btn" onclick="toggleMap()" style="background:none; border:1px solid #444; color:#ccc; cursor:pointer; padding:2px 8px; border-radius:4px; margin-left:5px;" title="Pantalla Completa">‚§¢ Expandir</button>
                    </div>
                </div>
                <canvas id="node-canvas"></canvas>
                <div class="map-hint">
                    <b>Click Derecho:</b> Opciones<br>
                    <b>Fondo:</b> Arrastrar para mover<br>
                    <b>Nodo:</b> Arrastrar para editar
                </div>
            </aside>
        </div>

        <!-- MODO VISUALIZADOR -->
        <div id="player-view" class="hidden">
            <button style="position:absolute; top:20px; right:20px; z-index:3000; background:rgba(0,0,0,0.7); color:white; border:none; padding:8px 15px; border-radius: 20px; cursor:pointer; font-weight: bold;" onclick="switchMode('editor')">Cerrar Visor</button>
            <div id="player-wrapper">
                <img id="player-img" src="">
                <div id="player-zones-layer"></div>
            </div>
            <div id="player-ui-layer"></div>
        </div>

    </div>

    <!-- MENU CONTEXTUAL MAPA -->
    <div id="context-menu" class="context-menu hidden">
        <div class="context-menu-item" onclick="ctxEditScene()">‚úèÔ∏è Editar Escena</div>
        <div class="context-menu-item" onclick="ctxDuplicate()">üìÑ Duplicar Escena</div>
        <div class="context-menu-item" onclick="ctxCreateBranch()">üå± Nueva Rama (Hija)</div>
        <div class="context-menu-item" onclick="ctxConnect()">üîó Unificar Ramas</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" style="color:#ff9800" onclick="ctxClearConnections()">‚úÇÔ∏è Borrar Uniones</div>
        <div class="context-menu-item danger" onclick="ctxDelete()">üóëÔ∏è Borrar Escena</div>
    </div>

    <!-- MODAL LINKEO ZONA -->
    <div id="link-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>üîó Configurar Zona</h3>
            <div class="form-group">
                <label>Al hacer clic, ir a:</label>
                <select id="link-target-select"></select>
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:10px; margin-top:15px; background:rgba(255,255,255,0.05); padding:10px; border-radius:4px;">
                <input type="checkbox" id="link-invisible" style="width:auto; height:18px; width:18px; cursor:pointer;">
                <label for="link-invisible" style="margin:0; cursor:pointer; font-size:0.9rem; line-height:1.2;">
                    <b>Ocultar zona</b> (Solo para bot√≥n "Siguiente")<br>
                    <span style="font-size:0.8rem; color:#888;">No se mostrar√° el bot√≥n en la imagen.</span>
                </label>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('link-modal')">Cancelar</button>
                <button class="btn-confirm" onclick="saveZone()">Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL COMPRESION PERSONALIZADA -->
    <div id="compression-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>‚ôªÔ∏è Comprimir Proyecto</h3>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">Ajusta la calidad para reducir el tama√±o del archivo.</p>
            <div class="form-group">
                <label>Resoluci√≥n M√°xima (px)</label>
                <input type="number" id="comp-width" value="2000" min="100" max="4000">
            </div>
            <div class="form-group">
                <label>Calidad JPG (%)</label>
                <input type="number" id="comp-quality" value="80" min="10" max="100">
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('compression-modal')">Cancelar</button>
                <button class="btn-confirm" onclick="applyCompression()">Comprimir</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL AUTO LINK -->
    <div id="autolink-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>‚ö° Auto-Conectar Escenas</h3>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">Genera enlaces y <b>reorganiza el mapa</b> autom√°ticamente.</p>
            <div class="form-group">
                <label>Modo de Conexi√≥n y Dise√±o:</label>
                <div class="autolink-option selected" onclick="selectAutoLinkMode(this, 'linear')">
                    <span class="autolink-icon">‚¨áÔ∏è</span>
                    <div><div>Lineal Vertical</div><div class="autolink-desc">Organiza en una l√≠nea vertical navegable.</div></div>
                </div>
                <div class="autolink-option" onclick="selectAutoLinkMode(this, 'circular')">
                    <span class="autolink-icon">üîÑ</span>
                    <div><div>Circular</div><div class="autolink-desc">Organiza en un c√≠rculo perfecto.</div></div>
                </div>
                <div class="autolink-option" onclick="selectAutoLinkMode(this, 'tree')">
                    <span class="autolink-icon">üåø</span>
                    <div><div>√Årbol (Ramificado)</div><div class="autolink-desc">Organiza en pir√°mide jer√°rquica.</div></div>
                </div>
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="autolink-clear" checked style="width:auto;">
                <label for="autolink-clear" style="margin:0; cursor:pointer;">Borrar zonas/enlaces existentes</label>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('autolink-modal')">Cancelar</button>
                <button class="btn-confirm" onclick="applyAutoLink()">Auto-Conectar</button>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIGURACI√ìN GLOBAL -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>‚öôÔ∏è Configuraci√≥n del Visor</h3>
            <div class="form-group">
                <label>Mostrar botones de navegaci√≥n</label>
                <select id="conf-show-nav">
                    <option value="true">S√≠, mostrar siempre</option>
                    <option value="false">No, solo usar zonas de clic</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:1">
                    <label>Estilo de Botones</label>
                    <select id="conf-btn-style">
                        <option value="classic">Cl√°sico (C√≠rculos)</option>
                        <option value="minimal">Minimalista (Flechas)</option>
                        <option value="comic">Comic (Burbujas)</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1">
                    <label>Posici√≥n</label>
                    <select id="conf-btn-pos">
                        <option value="sides">Laterales (Centro)</option>
                        <option value="bottom">Inferior (Esquinas)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Tama√±o de Botones (px)</label>
                <input type="number" id="conf-btn-size" min="20" max="200" value="50">
            </div>
            <div class="form-group">
                <label>Auto-ocultar interfaz (segundos)</label>
                <input type="number" id="conf-autohide" min="0" max="10" value="3" placeholder="0 para desactivar">
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('settings-modal')">Cancelar</button>
                <button class="btn-confirm" onclick="saveSettings()">Aplicar</button>
            </div>
        </div>
    </div>

    <!-- MODAL ALERTAS Y CONFIRMACI√ìN PERSONALIZADAS -->
    <div id="custom-alert-modal" class="modal-overlay hidden">
        <div class="modal" style="width: 300px; text-align: center;">
            <h3 id="alert-title">Aviso</h3>
            <p id="alert-msg">Mensaje</p>
            <div class="modal-buttons" style="justify-content: center;">
                <button class="btn-confirm" onclick="closeModal('custom-alert-modal')">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="custom-confirm-modal" class="modal-overlay hidden">
        <div class="modal" style="width: 300px; text-align: center;">
            <h3 id="confirm-title">Confirmaci√≥n</h3>
            <p id="confirm-msg">¬øSeguro?</p>
            <div class="modal-buttons" style="justify-content: center;">
                <button class="btn-cancel" onclick="closeModal('custom-confirm-modal')">Cancelar</button>
                <button class="btn-confirm btn-danger" id="confirm-btn-action">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // --- UTILIDADES DE UI (REEMPLAZO DE ALERT/CONFIRM) ---
        let confirmCallback = null;
        let storageAlertShown = false; 

        function showAlert(msg) {
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('custom-alert-modal').classList.remove('hidden');
        }

        function confirmAction(msg, callback) {
            confirmCallback = callback;
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('custom-confirm-modal').classList.remove('hidden');
        }

        document.getElementById('confirm-btn-action').onclick = function() {
            if (confirmCallback) confirmCallback();
            closeModal('custom-confirm-modal');
            confirmCallback = null;
        };

        // --- ESTADO GLOBAL ---
        let project = {
            meta: { title: "Mi Comic" },
            settings: { showNav: true, navStyle: 'classic', navPos: 'sides', autoHide: 2000, btnSize: 50 },
            startSceneId: null,
            scenes: {}
        };
        
        let state = {
            currentSceneId: null, tool: 'draw', isDrawing: false, startX: 0, startY: 0, tempZone: null,
            editingZoneIndex: null, 
            dragNode: null, dragLinkStart: null, mapOffset: {x: 0, y: 0}, mouseMap: {x:0, y:0},
            mapExpanded: false, isPanningMap: false, panStart: {x:0, y:0}, panStartOffset: {x:0, y:0},
            autoLinkMode: 'linear',
            ctxMenuNodeId: null
        };

        const els = {
            sceneList: document.getElementById('scene-list-container'),
            editorImg: document.getElementById('editor-img'),
            wrapper: document.getElementById('interactive-wrapper'),
            viewport: document.getElementById('viewport'),
            drawBox: document.getElementById('draw-box'),
            nodeCanvas: document.getElementById('node-canvas'),
            playerUI: document.getElementById('player-ui-layer'),
            appContainer: document.getElementById('app-container'),
            ctxMenu: document.getElementById('context-menu')
        };

        // --- INICIALIZACI√ìN ---
        window.onload = () => {
            loadProject();
            setupMapEvents();
            setupCanvasEvents();
            requestAnimationFrame(drawMapLoop);
            window.addEventListener('click', () => els.ctxMenu.classList.add('hidden'));
        };

        // --- GESTI√ìN DE PROYECTO ---
        function saveProject() {
            try { 
                const projectToSave = JSON.parse(JSON.stringify(project));
                Object.values(projectToSave.scenes).forEach(s => delete s.imgFull);
                localStorage.setItem('cf_project', JSON.stringify(projectToSave)); 
            } 
            catch (e) { 
                if (!storageAlertShown) {
                    showAlert("‚ö†Ô∏è MEMORIA DE NAVEGADOR LLENA\n\nLos cambios se ven ahora, pero NO SE GUARDAR√ÅN si recargas la p√°gina.\n\nUsa 'Exportar HTML' para guardar tu progreso en un archivo."); 
                    storageAlertShown = true;
                }
            }
        }

        function loadProject() {
            const data = localStorage.getItem('cf_project');
            if (data) {
                project = JSON.parse(data);
                Object.values(project.scenes).forEach((s, i) => {
                    if(s.x === undefined) { s.x = 100 + (i%5)*120; s.y = 100 + Math.floor(i/5)*100; }
                });
                renderSceneList();
                if(Object.keys(project.scenes).length > 0) selectScene(Object.keys(project.scenes)[0]);
            }
        }
        
        // --- FUNCI√ìN DE IMPORTACI√ìN ROBUSTA CON POP-UP (NO NATIVO) ---
        function handleProjectImport(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                let loadedData = null;

                try {
                    if(file.name.toLowerCase().endsWith('.html')) {
                        // 1. Encontrar el inicio de la declaraci√≥n
                        const varMatch = /(?:const|var|let)\s+(?:P|project)\s*=\s*/i.exec(text);
                        
                        if (varMatch) {
                            const startIndex = varMatch.index + varMatch[0].length;
                            const firstBrace = text.indexOf('{', startIndex);
                            
                            if (firstBrace !== -1) {
                                // 2. CONTADOR DE LLAVES (Brace Counting)
                                let braceCount = 0;
                                let endIndex = -1;
                                let inString = false;
                                let isEscaping = false;

                                for (let i = firstBrace; i < text.length; i++) {
                                    const char = text[i];
                                    if (inString) {
                                        if (isEscaping) isEscaping = false;
                                        else {
                                            if (char === '\\') isEscaping = true;
                                            else if (char === '"') inString = false;
                                        }
                                    } else {
                                        if (char === '"') inString = true;
                                        else if (char === '{') braceCount++;
                                        else if (char === '}') {
                                            braceCount--;
                                            if (braceCount === 0) {
                                                endIndex = i + 1;
                                                break;
                                            }
                                        }
                                    }
                                }

                                if (endIndex !== -1) {
                                    const jsonStr = text.substring(firstBrace, endIndex);
                                    loadedData = JSON.parse(jsonStr);
                                } else {
                                    throw new Error("No se pudo encontrar el cierre del objeto JSON.");
                                }
                            } else {
                                throw new Error("No se encontr√≥ el objeto JSON.");
                            }
                        } else {
                             // Fallback simple
                             const regex = /(?:const|var|let)\s+(?:P|project)\s*=\s*(\{[\s\S]*?\});?/i;
                             const match = regex.exec(text);
                             if(match && match[1]) loadedData = JSON.parse(match[1]);
                        }
                    } else if (file.name.toLowerCase().endsWith('.json')) {
                        loadedData = JSON.parse(text);
                    }

                    if(loadedData && loadedData.scenes) {
                        const isLarge = text.length > 5 * 1024 * 1024;
                        let msg = "¬øCargar este proyecto? Se reemplazar√° el actual.";
                        if (isLarge) msg += "\n\n‚ö†Ô∏è Archivo grande detectado. Te sugiero comprimirlo despu√©s de cargar.";

                        // USANDO EL POP-UP PERSONALIZADO EN LUGAR DE CONFIRM()
                        confirmAction(msg, () => {
                            project = loadedData;
                            Object.values(project.scenes).forEach((s, i) => {
                                if(s.x === undefined) { s.x = 100 + (i%5)*120; s.y = 100 + Math.floor(i/5)*100; }
                            });
                            saveProject();
                            renderSceneList();
                            if(project.startSceneId) selectScene(project.startSceneId);
                            else if(Object.keys(project.scenes).length > 0) selectScene(Object.keys(project.scenes)[0]);
                            
                            // Si es grande, sugerimos comprimir con otro Pop-up
                            if(isLarge) {
                                setTimeout(() => {
                                    confirmAction("El proyecto cargado es pesado. ¬øQuieres comprimir las im√°genes ahora?", () => {
                                        openCompressionModal(); // Abre el modal de configuraci√≥n en vez de hacerlo directo
                                    });
                                }, 600);
                            } else {
                                showAlert("Proyecto importado con √©xito.");
                            }
                        });
                    } else {
                        throw new Error("Formato de datos incorrecto.");
                    }
                } catch(err) {
                    showAlert("Error al importar: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function clearProject() {
            localStorage.removeItem('cf_project');
            location.reload();
        }

        function handleImageUpload(input) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // CONFIGURACI√ìN PREDETERMINADA: 2000px y 80%
                        const MAX_SIZE = 2000; 
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }
                        
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Calidad 0.80
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.80);
                        const originalDataUrl = e.target.result; 

                        const id = 's_' + Date.now() + Math.floor(Math.random()*1000);
                        let name = file.name;
                        if (name.lastIndexOf('.') > 0) name = name.substring(0, name.lastIndexOf('.'));

                        project.scenes[id] = {
                            id, name: name, 
                            img: compressedDataUrl, 
                            imgFull: originalDataUrl,
                            zones: [], 
                            x: Math.random() * 200 + 50, y: Math.random() * 200 + 50
                        };
                        
                        if(!project.startSceneId) project.startSceneId = id;
                        saveProject();
                        renderSceneList();
                        if(Object.keys(project.scenes).length === 1) selectScene(id);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
            input.value = '';
        }
        
        // --- NUEVA L√ìGICA DE COMPRESI√ìN CON MODAL ---
        
        function openCompressionModal() {
            // Valores por defecto solicitados: 2000px, 80%
            document.getElementById('comp-width').value = 2000;
            document.getElementById('comp-quality').value = 80;
            document.getElementById('compression-modal').classList.remove('hidden');
        }

        function applyCompression() {
            const w = parseInt(document.getElementById('comp-width').value) || 2000;
            const q = parseInt(document.getElementById('comp-quality').value) || 80;
            closeModal('compression-modal');
            
            // Ejecutar con indicador visual
            executeOptimization(w, q / 100);
        }

        // --- L√ìGICA DE OPTIMIZACI√ìN REAL (As√≠ncrona) ---
        async function executeOptimization(targetW = 2000, targetQ = 0.8) {
            const ids = Object.keys(project.scenes);
            let count = 0;
            const btn = document.querySelector('.optimize-btn');
            const originalText = btn ? btn.innerText : "‚ôªÔ∏è Comprimir";
            if(btn) btn.innerText = "‚è≥ Procesando...";
            
            for (const id of ids) {
                await new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let width = img.width;
                        let height = img.height;
                        
                        // Redimensionar si excede el targetW
                        if (width > height) {
                            if (width > targetW) { height *= targetW / width; width = targetW; }
                        } else {
                            if (height > targetW) { width *= targetW / height; height = targetW; }
                        }
                        
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Aplicar nueva calidad
                        project.scenes[id].img = canvas.toDataURL('image/jpeg', targetQ);
                        delete project.scenes[id].imgFull; 
                        resolve();
                    };
                    img.onerror = resolve; 
                    img.src = project.scenes[id].img;
                });
                count++;
            }
            
            saveProject();
            if(state.currentSceneId) {
                els.editorImg.src = project.scenes[state.currentSceneId].img;
            }
            if(btn) btn.innerText = originalText;
            showAlert(`¬°Listo! ${count} im√°genes optimizadas a ${targetW}px / ${Math.round(targetQ*100)}%.`);
        }

        // --- EDITOR UI ---
        function renderSceneList() {
            els.sceneList.innerHTML = '';
            const scenesArray = Object.values(project.scenes);
            scenesArray.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));

            scenesArray.forEach((s, index) => {
                const div = document.createElement('div');
                div.className = `scene-item ${state.currentSceneId === s.id ? 'active' : ''}`;
                div.onclick = () => selectScene(s.id);
                
                let badges = '';
                if(project.startSceneId === s.id) badges += '<span class="badge start">Inicio</span>';
                if(s.zones.length > 0) badges += `<span class="badge">Branches: ${s.zones.length}</span>`;
                
                div.innerHTML = `
                    <div class="scene-index">${index + 1}</div>
                    <img src="${s.img}" class="scene-thumb">
                    <div class="scene-info"><div class="scene-name">${s.name}</div><div class="scene-badges">${badges}</div></div>
                `;
                els.sceneList.appendChild(div);
            });
        }

        function selectScene(id) {
            if(!project.scenes[id]) return;
            state.currentSceneId = id;
            els.editorImg.src = project.scenes[id].img;
            els.editorImg.style.display = 'block';
            document.getElementById('empty-state-msg').style.display = 'none';
            document.getElementById('current-scene-name').innerText = project.scenes[id].name;
            renderSceneList();
            renderZones();
        }

        function setAsStartScene() {
            if(!state.currentSceneId) return;
            project.startSceneId = state.currentSceneId;
            saveProject();
            renderSceneList();
        }

        // --- WRAPPERS DE BORRADO ---
        function reqClearConnections() {
            if(!state.currentSceneId) return;
            confirmAction("¬øBorrar todas las zonas/uniones de esta escena?", () => executeClearConnections(state.currentSceneId));
        }

        function reqDeleteScene() {
            if(!state.currentSceneId) return;
            confirmAction("¬øBorrar esta escena y sus conexiones?", () => executeDeleteScene(state.currentSceneId));
        }

        function executeClearConnections(id) {
            if(project.scenes[id]) {
                project.scenes[id].zones = [];
                saveProject();
                if(state.currentSceneId === id) renderZones();
                renderSceneList();
            }
        }

        function executeDeleteScene(id) {
            Object.values(project.scenes).forEach(s => { 
                s.zones = s.zones.filter(z => z.targetId !== id); 
            });
            delete project.scenes[id];
            if(project.startSceneId === id) project.startSceneId = null;
            if(state.currentSceneId === id) {
                state.currentSceneId = null;
                els.editorImg.style.display = 'none';
                els.editorImg.src = '';
                document.getElementById('empty-state-msg').style.display = 'block';
                document.getElementById('current-scene-name').innerText = "...";
                renderZones();
            } else {
                renderZones();
            }
            saveProject();
            renderSceneList();
        }

        // --- ZONAS Y DIBUJO ---
        function setTool(t) {
            state.tool = t;
            els.viewport.setAttribute('data-mode', t);
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-tool-${t}`).classList.add('active');
        }

        function setupCanvasEvents() {
            els.wrapper.addEventListener('mousedown', (e) => {
                if(e.target.classList.contains('zone-ctrl-btn') || e.target.classList.contains('zone-resize')) return;
                if(!state.currentSceneId) return;
                if(state.tool !== 'draw') return;
                e.preventDefault();
                state.isDrawing = true;
                const rect = els.wrapper.getBoundingClientRect();
                state.startX = e.clientX - rect.left;
                state.startY = e.clientY - rect.top;
                els.drawBox.style.display = 'block';
                updateDrawBox(state.startX, state.startY, 0, 0);
            });

            window.addEventListener('mousemove', (e) => {
                if(state.isDrawing) {
                    const rect = els.wrapper.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    updateDrawBox(Math.min(x, state.startX), Math.min(y, state.startY), Math.abs(x - state.startX), Math.abs(y - state.startY));
                }
            });

            window.addEventListener('mouseup', () => {
                if(state.isDrawing) {
                    state.isDrawing = false;
                    els.drawBox.style.display = 'none';
                    const rect = els.wrapper.getBoundingClientRect();
                    const box = els.drawBox.getBoundingClientRect();
                    if(box.width > 10 && box.height > 10) {
                        state.tempZone = {
                            x: ((box.left - rect.left) / rect.width) * 100,
                            y: ((box.top - rect.top) / rect.height) * 100,
                            w: (box.width / rect.width) * 100,
                            h: (box.height / rect.height) * 100
                        };
                        state.editingZoneIndex = null; 
                        openLinkModal();
                    }
                }
            });
        }

        function updateDrawBox(x, y, w, h) {
            els.drawBox.style.left = x + 'px'; els.drawBox.style.top = y + 'px';
            els.drawBox.style.width = w + 'px'; els.drawBox.style.height = h + 'px';
        }

        function renderZones() {
            document.querySelectorAll('.zone').forEach(z => z.remove());
            if (!state.currentSceneId || !project.scenes[state.currentSceneId]) return;
            
            const scene = project.scenes[state.currentSceneId];
            scene.zones.forEach((z, idx) => {
                const el = document.createElement('div');
                el.className = 'zone';
                if(z.invisible) el.classList.add('is-invisible');
                el.style.left = z.x + '%'; el.style.top = z.y + '%';
                el.style.width = z.w + '%'; el.style.height = z.h + '%';
                const targetName = project.scenes[z.targetId]?.name || '???';
                const visIcon = z.invisible ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : '';
                el.innerHTML = `
                    <div class="zone-branch-tag">${idx + 1}</div>
                    <span class="zone-label">${visIcon} Ir a: ${targetName}</span>
                    <div class="zone-ctrl-btn zone-edit" onclick="editZone(${idx})">‚öôÔ∏è</div>
                    <div class="zone-ctrl-btn zone-delete" onclick="deleteZone(${idx})">√ó</div>
                    <div class="zone-resize"></div>
                `;
                addDragLogic(el, idx);
                addResizeLogic(el.querySelector('.zone-resize'), el, idx);
                els.wrapper.appendChild(el);
            });
        }
        
        function addDragLogic(el, idx) {
            let isDragging = false, startX, startY, startLeft, startTop;
            el.addEventListener('mousedown', (e) => {
                if(e.target.classList.contains('zone-ctrl-btn') || e.target.classList.contains('zone-resize')) return;
                e.stopPropagation(); isDragging = true; startX = e.clientX; startY = e.clientY;
                startLeft = parseFloat(el.style.left); startTop = parseFloat(el.style.top);
            });
            window.addEventListener('mousemove', (e) => {
                if(!isDragging) return;
                const rect = els.wrapper.getBoundingClientRect();
                const dx = ((e.clientX - startX) / rect.width) * 100;
                const dy = ((e.clientY - startY) / rect.height) * 100;
                el.style.left = (startLeft + dx) + '%'; el.style.top = (startTop + dy) + '%';
            });
            window.addEventListener('mouseup', (e) => {
                if(!isDragging) return;
                isDragging = false;
                project.scenes[state.currentSceneId].zones[idx].x = parseFloat(el.style.left);
                project.scenes[state.currentSceneId].zones[idx].y = parseFloat(el.style.top);
                saveProject();
            });
        }

        function addResizeLogic(handle, zone, idx) {
            let isResizing = false, startX, startY, startW, startH;
            handle.addEventListener('mousedown', (e) => {
                e.stopPropagation(); isResizing = true;
                startX = e.clientX; startY = e.clientY;
                startW = parseFloat(zone.style.width); startH = parseFloat(zone.style.height);
            });
            window.addEventListener('mousemove', (e) => {
                if(!isResizing) return;
                const rect = els.wrapper.getBoundingClientRect();
                const dW = ((e.clientX - startX) / rect.width) * 100;
                const dH = ((e.clientY - startY) / rect.height) * 100;
                zone.style.width = Math.max(2, startW + dW) + '%';
                zone.style.height = Math.max(2, startH + dH) + '%';
            });
            window.addEventListener('mouseup', (e) => {
                if(!isResizing) return;
                isResizing = false;
                project.scenes[state.currentSceneId].zones[idx].w = parseFloat(zone.style.width);
                project.scenes[state.currentSceneId].zones[idx].h = parseFloat(zone.style.height);
                saveProject();
            });
        }

        function deleteZone(idx) {
            project.scenes[state.currentSceneId].zones.splice(idx, 1);
            saveProject(); renderZones();
        }
        
        function editZone(idx) {
            state.editingZoneIndex = idx;
            openLinkModal();
        }

        // --- SISTEMA DE MAPA ---
        function toggleMap() {
            state.mapExpanded = !state.mapExpanded;
            els.appContainer.classList.toggle('map-expanded');
            document.querySelector('.map-expand-btn').innerText = state.mapExpanded ? 'üóï Reducir' : '‚§¢ Expandir';
        }

        function setupMapEvents() {
            const cvs = els.nodeCanvas;
            cvs.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const rect = cvs.getBoundingClientRect();
                const realMx = (e.clientX - rect.left) - state.mapOffset.x;
                const realMy = (e.clientY - rect.top) - state.mapOffset.y;
                const ids = Object.keys(project.scenes);
                state.ctxMenuNodeId = null;
                for(let i=ids.length-1; i>=0; i--) {
                    const s = project.scenes[ids[i]];
                    if (Math.abs(realMx - s.x) < 50 && Math.abs(realMy - s.y) < 25) {
                        state.ctxMenuNodeId = s.id; break;
                    }
                }
                if (state.ctxMenuNodeId) {
                    els.ctxMenu.style.left = e.clientX + 'px'; els.ctxMenu.style.top = e.clientY + 'px';
                    els.ctxMenu.classList.remove('hidden');
                }
            });

            cvs.addEventListener('mousedown', (e) => {
                if(e.button !== 0) return; 
                const rect = cvs.getBoundingClientRect();
                const realMx = (e.clientX - rect.left) - state.mapOffset.x;
                const realMy = (e.clientY - rect.top) - state.mapOffset.y;
                const ids = Object.keys(project.scenes);
                let hitNode = false;

                for(let i=ids.length-1; i>=0; i--) {
                    const s = project.scenes[ids[i]];
                    const dx = realMx - s.x; const dy = realMy - s.y;
                    if(Math.sqrt(Math.pow(realMx - (s.x+50), 2) + Math.pow(realMy - s.y, 2)) < 15) {
                        state.dragLinkStart = s.id; hitNode = true; return;
                    }
                    if (Math.abs(dx) < 50 && Math.abs(dy) < 25) {
                        state.dragNode = s.id; selectScene(s.id); hitNode = true; return;
                    }
                }
                if (!hitNode) {
                    state.isPanningMap = true;
                    state.panStart = { x: e.clientX, y: e.clientY };
                    state.panStartOffset = { ...state.mapOffset };
                    cvs.style.cursor = 'grabbing';
                }
            });
            
            cvs.addEventListener('dblclick', (e) => {
                const rect = cvs.getBoundingClientRect();
                const realMx = (e.clientX - rect.left) - state.mapOffset.x;
                const realMy = (e.clientY - rect.top) - state.mapOffset.y;
                const ids = Object.keys(project.scenes);
                for(let id of ids) {
                    const s = project.scenes[id];
                    if(Math.abs(realMx - s.x) < 50 && Math.abs(realMy - s.y) < 25) {
                        if(state.mapExpanded) toggleMap();
                        selectScene(s.id);
                        break;
                    }
                }
            });

            window.addEventListener('mousemove', (e) => {
                const rect = cvs.getBoundingClientRect();
                state.mouseMap = { x: e.clientX - rect.left, y: e.clientY - rect.top };
                if(state.dragNode) {
                    const s = project.scenes[state.dragNode];
                    s.x = state.mouseMap.x - state.mapOffset.x; s.y = state.mouseMap.y - state.mapOffset.y;
                } else if (state.isPanningMap) {
                    const diffX = e.clientX - state.panStart.x;
                    const diffY = e.clientY - state.panStart.y;
                    state.mapOffset.x = state.panStartOffset.x + diffX;
                    state.mapOffset.y = state.panStartOffset.y + diffY;
                }
            });

            window.addEventListener('mouseup', () => {
                if(state.dragLinkStart) {
                    const ids = Object.keys(project.scenes);
                    const realMx = state.mouseMap.x - state.mapOffset.x;
                    const realMy = state.mouseMap.y - state.mapOffset.y;
                    for(let id of ids) {
                        const s = project.scenes[id];
                        if (id !== state.dragLinkStart && Math.abs(realMx - s.x) < 50 && Math.abs(realMy - s.y) < 25) {
                            project.scenes[state.dragLinkStart].zones.push({ x: 40, y: 40, w: 20, h: 20, targetId: id });
                            saveProject(); renderSceneList();
                            if(state.currentSceneId === state.dragLinkStart) renderZones();
                            break;
                        }
                    }
                }
                state.dragNode = null; state.dragLinkStart = null;
                if(state.isPanningMap) { state.isPanningMap = false; cvs.style.cursor = 'grab'; }
            });
        }

        // --- ACCIONES MENU CONTEXTUAL ---
        function ctxEditScene() {
            if(state.ctxMenuNodeId) {
                if(state.mapExpanded) toggleMap();
                selectScene(state.ctxMenuNodeId);
            }
            els.ctxMenu.classList.add('hidden');
        }

        function ctxDuplicate() {
            if(state.ctxMenuNodeId) {
                const src = project.scenes[state.ctxMenuNodeId];
                if(src) {
                    const newId = 's_' + Date.now();
                    const copy = JSON.parse(JSON.stringify(src));
                    copy.id = newId;
                    copy.name = src.name + " (Copia)";
                    copy.x += 30; copy.y += 30;
                    project.scenes[newId] = copy;
                    saveProject(); renderSceneList();
                }
            }
            els.ctxMenu.classList.add('hidden');
        }

        function ctxClearConnections() {
            if(state.ctxMenuNodeId) {
                confirmAction("¬øEliminar todas las conexiones salientes?", () => executeClearConnections(state.ctxMenuNodeId));
            }
            els.ctxMenu.classList.add('hidden');
        }

        function ctxDelete() {
            if(state.ctxMenuNodeId) {
                confirmAction("¬øEliminar escena?", () => executeDeleteScene(state.ctxMenuNodeId));
            }
            els.ctxMenu.classList.add('hidden');
        }

        function ctxCreateBranch() {
            if(state.ctxMenuNodeId) {
                const newId = 's_' + Date.now();
                const parent = project.scenes[state.ctxMenuNodeId];
                project.scenes[newId] = {
                    id: newId, name: "Nueva Rama", img: "", zones: [],
                    x: parent.x + 150, y: parent.y + 50
                };
                parent.zones.push({ x: 40, y: 80, w: 20, h: 15, targetId: newId });
                saveProject(); renderSceneList();
                selectScene(newId);
            }
            els.ctxMenu.classList.add('hidden');
        }

        function ctxConnect() {
            if(state.ctxMenuNodeId) {
                state.currentSceneId = state.ctxMenuNodeId; 
                state.tempZone = { x: 40, y: 40, w: 20, h: 20 };
                state.editingZoneIndex = null;
                openLinkModal();
            }
            els.ctxMenu.classList.add('hidden');
        }

        // --- DIBUJADO DEL MAPA ---
        function drawMapLoop() {
            const ctx = els.nodeCanvas.getContext('2d');
            const w = els.nodeCanvas.width = els.nodeCanvas.parentElement.clientWidth;
            const h = els.nodeCanvas.height = els.nodeCanvas.parentElement.clientHeight;
            ctx.fillStyle = '#151515'; ctx.fillRect(0, 0, w, h);
            const ox = state.mapOffset.x; const oy = state.mapOffset.y;

            Object.values(project.scenes).forEach(s => {
                s.zones.forEach((z, idx) => {
                    if(z.targetId && project.scenes[z.targetId]) {
                        const t = project.scenes[z.targetId];
                        drawSmartArrow(ctx, s.x+ox, s.y+oy, t.x+ox, t.y+oy, idx+1);
                    }
                });
            });

            if(state.dragLinkStart) {
                const s = project.scenes[state.dragLinkStart];
                ctx.beginPath();
                ctx.moveTo(s.x + 50 + ox, s.y + oy);
                ctx.lineTo(state.mouseMap.x, state.mouseMap.y);
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]); ctx.stroke(); ctx.setLineDash([]);
            }

            Object.values(project.scenes).forEach(s => {
                const dx = s.x + ox, dy = s.y + oy;
                const isSel = state.currentSceneId === s.id;
                ctx.fillStyle = isSel ? '#333' : '#222';
                ctx.strokeStyle = isSel ? '#bb86fc' : '#444';
                ctx.lineWidth = isSel ? 3 : 1;
                ctx.beginPath(); ctx.roundRect(dx - 50, dy - 25, 100, 50, 8); ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#fff'; ctx.font = '12px Segoe UI'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(s.name, dx, dy);
                ctx.beginPath(); ctx.arc(dx + 50, dy, 6, 0, Math.PI*2);
                ctx.fillStyle = '#03dac6'; ctx.fill(); ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.stroke();
                if(project.startSceneId === s.id) {
                    ctx.fillStyle = '#03dac6'; ctx.beginPath(); ctx.arc(dx - 55, dy - 30, 5, 0, Math.PI*2); ctx.fill();
                }
            });
            requestAnimationFrame(drawMapLoop);
        }

        function drawSmartArrow(ctx, x1, y1, x2, y2, label) {
            const w = 50, h = 25; 
            let start = {x: x1, y: y1}, end = {x: x2, y: y2};
            let cp1 = {x:0,y:0}, cp2 = {x:0,y:0};

            if (Math.abs(x2 - x1) > Math.abs(y2 - y1)) {
                if (x2 > x1) { start.x += w; end.x -= w; cp1 = {x: start.x + 50, y: start.y}; cp2 = {x: end.x - 50, y: end.y}; } 
                else { start.x -= w; end.x += w; cp1 = {x: start.x - 50, y: start.y}; cp2 = {x: end.x + 50, y: end.y}; }
            } else {
                if (y2 > y1) { start.y += h; end.y -= h; cp1 = {x: start.x, y: start.y + 50}; cp2 = {x: end.x, y: end.y - 50}; } 
                else { start.y -= h; end.y += h; cp1 = {x: start.x, y: start.y - 50}; cp2 = {x: end.x, y: end.y + 50}; }
            }

            ctx.beginPath(); ctx.moveTo(start.x, start.y); ctx.bezierCurveTo(cp1.x, cp1.y, cp2.x, cp2.y, end.x, end.y);
            ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 4; ctx.strokeStyle = '#03dac6'; ctx.lineWidth = 3; ctx.stroke(); ctx.shadowColor = "transparent";

            const angle = Math.atan2(end.y - cp2.y, end.x - cp2.x); const head = 12;
            ctx.beginPath(); ctx.moveTo(end.x, end.y);
            ctx.lineTo(end.x - head * Math.cos(angle - Math.PI/6), end.y - head * Math.sin(angle - Math.PI/6));
            ctx.lineTo(end.x - head * Math.cos(angle + Math.PI/6), end.y - head * Math.sin(angle + Math.PI/6));
            ctx.fillStyle = '#03dac6'; ctx.fill();

            const midX = (start.x + end.x) / 2; const midY = (start.y + end.y) / 2;
            ctx.beginPath(); ctx.arc(midX, midY, 8, 0, Math.PI*2);
            ctx.fillStyle = '#03dac6'; ctx.fill();
            ctx.fillStyle = '#000'; ctx.font = 'bold 10px Arial'; ctx.textAlign = 'center'; ctx.textBaseline='middle';
            ctx.fillText(label, midX, midY);
        }

        function autoLayout() { layoutScenes(Object.values(project.scenes), 'circular'); }
        function layoutScenes(scenes, mode) {
            const w = Math.max(els.nodeCanvas.width, 800); 
            const h = Math.max(els.nodeCanvas.height, 600);
            const cx = w / 2;
            
            if (mode === 'circular') {
                const r = Math.min(w, h) / 3;
                scenes.forEach((s, i) => {
                    const ang = (i / scenes.length) * Math.PI * 2 - Math.PI / 2;
                    s.x = cx + Math.cos(ang) * r; s.y = h/2 + Math.sin(ang) * r;
                });
            } else if (mode === 'linear') {
                scenes.forEach((s, i) => { s.x = cx; s.y = 100 + i * 150; });
            } else if (mode === 'tree') {
                scenes.forEach((s, i) => {
                    const level = Math.floor(Math.log2(i + 1));
                    const levelCap = Math.pow(2, level);
                    const idx = (i + 1) - levelCap;
                    const spread = Math.max(w * 0.8, levelCap * 120);
                    s.y = 80 + level * 120;
                    s.x = (w/2 - spread/2) + (idx + 1) * (spread / (levelCap + 1));
                });
            }
            state.mapOffset = {x: 0, y: 0};
            saveProject();
        }

        function openAutoLink() { document.getElementById('autolink-modal').classList.remove('hidden'); }
        function selectAutoLinkMode(el, mode) {
            document.querySelectorAll('.autolink-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected'); state.autoLinkMode = mode;
        }
        function applyAutoLink() {
            const scenes = Object.values(project.scenes).sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));
            if(scenes.length < 2) { showAlert("Min 2 escenas requeridas."); return; }
            if(document.getElementById('autolink-clear').checked) scenes.forEach(s => s.zones = []);
            
            project.startSceneId = scenes[0].id;
            const mode = state.autoLinkMode;

            if(mode === 'linear' || mode === 'circular') {
                for(let i=0; i<scenes.length; i++) {
                    if(i === scenes.length-1) { if(mode==='circular') addZone(scenes[i], scenes[0].id, 'br'); }
                    else addZone(scenes[i], scenes[i+1].id, 'br');
                }
            } else if (mode === 'tree') {
                for(let i=0; i<scenes.length; i++) {
                    const l = i*2 + 1; const r = i*2 + 2;
                    if(l < scenes.length) addZone(scenes[i], scenes[l].id, 'bl');
                    if(r < scenes.length) addZone(scenes[i], scenes[r].id, 'br');
                }
            }
            layoutScenes(scenes, mode);
            saveProject(); renderSceneList(); renderZones(); closeModal('autolink-modal');
        }
        function addZone(s, tid, pos) {
            let x=40, y=80;
            if(pos==='br') x=75; else if(pos==='bl') x=5;
            s.zones.push({x, y, w:20, h:15, targetId:tid, invisible:false});
        }

        function openLinkModal() {
            const sel = document.getElementById('link-target-select'); sel.innerHTML = '';
            Object.values(project.scenes).forEach(s => { if(s.id !== state.currentSceneId) sel.add(new Option(s.name, s.id)); });
            
            const checkbox = document.getElementById('link-invisible');
            if (state.editingZoneIndex !== null) {
                const zone = project.scenes[state.currentSceneId].zones[state.editingZoneIndex];
                sel.value = zone.targetId;
                checkbox.checked = zone.invisible || false;
            } else {
                checkbox.checked = false;
            }
            
            document.getElementById('link-modal').classList.remove('hidden');
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); if(id==='link-modal') { state.tempZone=null; state.editingZoneIndex=null; } }
        
        function saveZone() {
            const tid = document.getElementById('link-target-select').value;
            const invisible = document.getElementById('link-invisible').checked;
            
            if (tid) {
                if (state.editingZoneIndex !== null) {
                    project.scenes[state.currentSceneId].zones[state.editingZoneIndex].targetId = tid;
                    project.scenes[state.currentSceneId].zones[state.editingZoneIndex].invisible = invisible;
                } else if (state.tempZone) {
                    state.tempZone.targetId = tid;
                    state.tempZone.invisible = invisible;
                    project.scenes[state.currentSceneId].zones.push(state.tempZone);
                }
                saveProject(); renderZones(); renderSceneList(); closeModal('link-modal');
            }
        }
        function openSettings() { 
            document.getElementById('conf-show-nav').value = project.settings.showNav.toString();
            document.getElementById('conf-btn-style').value = project.settings.navStyle;
            document.getElementById('conf-btn-pos').value = project.settings.navPos;
            document.getElementById('conf-btn-size').value = project.settings.btnSize || 50;
            document.getElementById('conf-autohide').value = project.settings.autoHide / 1000;
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        function saveSettings() { 
            project.settings.showNav = document.getElementById('conf-show-nav').value === 'true';
            project.settings.navStyle = document.getElementById('conf-btn-style').value;
            project.settings.navPos = document.getElementById('conf-btn-pos').value;
            project.settings.btnSize = parseInt(document.getElementById('conf-btn-size').value) || 50;
            project.settings.autoHide = parseFloat(document.getElementById('conf-autohide').value) * 1000;
            saveProject();
            closeModal('settings-modal'); 
        }
        
        // --- VISUALIZADOR ---
        let playerHistory = [];
        function switchMode(m) {
            if(m === 'player') {
                if(!project.startSceneId) { showAlert("Falta inicio"); return; }
                document.getElementById('player-view').classList.remove('hidden');
                playerHistory = []; loadPlayerScene(project.startSceneId); setupPlayerUI();
            } else { document.getElementById('player-view').classList.add('hidden'); }
        }
        function setupPlayerUI() {
            els.playerUI.innerHTML = ''; 
            if(!project.settings.showNav) return;
            const s = project.settings;
            const size = s.btnSize || 50;

            const makeBtn = (txt, isRight, fn) => {
                const btn = document.createElement('div');
                btn.className = `nav-overlay nav-btn-${s.navStyle}`;
                btn.innerHTML = txt;
                btn.onclick = (e) => { e.stopPropagation(); fn(); };
                
                if(s.navPos === 'sides') {
                    btn.style.top = '50%'; btn.style.transform = 'translateY(-50%)'; btn.style[isRight ? 'right' : 'left'] = '20px';
                } else {
                    btn.style.bottom = '20px'; btn.style[isRight ? 'right' : 'left'] = '20px';
                }

                if (s.navStyle === 'minimal') { btn.style.fontSize = size + 'px'; btn.style.width='auto'; btn.style.height='auto'; btn.style.padding = '0'; } 
                else if (s.navStyle === 'classic') {
                    btn.style.width = size + 'px'; btn.style.height = size + 'px'; btn.style.fontSize = (size * 0.4) + 'px';
                    btn.style.display = 'flex'; btn.style.justifyContent = 'center'; btn.style.alignItems = 'center';
                } else if (s.navStyle === 'comic') {
                    btn.style.fontSize = (size * 0.4) + 'px'; btn.style.padding = (size * 0.2) + 'px';
                }
                els.playerUI.appendChild(btn);
            };
            const icPrev = s.navStyle==='minimal'?'&#9664;':(s.navStyle==='comic'?'ATRAS':'&#10094;');
            const icNext = s.navStyle==='minimal'?'&#9654;':(s.navStyle==='comic'?'SIGUIENTE':'&#10095;');
            makeBtn(icPrev, false, playerBack); makeBtn(icNext, true, playerNext);
        }

        function playerNext() {
            const currentId = playerHistory[playerHistory.length-1];
            const currentScene = project.scenes[currentId];
            if(currentScene && currentScene.zones.length > 0) loadPlayerScene(currentScene.zones[0].targetId);
        }

        function loadPlayerScene(id) {
            const s = project.scenes[id]; if(!s) return;
            if(playerHistory[playerHistory.length-1] !== id) playerHistory.push(id);
            setupPlayerUI(); 
            document.getElementById('player-img').src = s.img;
            const layer = document.getElementById('player-zones-layer'); layer.innerHTML='';
            s.zones.forEach(z => {
                if (z.invisible) return;
                
                const d = document.createElement('div'); d.className='play-zone';
                d.style.left=z.x+'%';d.style.top=z.y+'%';d.style.width=z.w+'%';d.style.height=z.h+'%';
                d.onclick = () => loadPlayerScene(z.targetId); layer.appendChild(d);
            });
        }
        function playerBack() {
            if(playerHistory.length > 1) { playerHistory.pop(); loadPlayerScene(playerHistory.pop()); }
        }
        
        // --- FUNCI√ìN DE EXPORTACI√ìN OPTIMIZADA PARA MEMORIA (Blob Array) ---
        function exportProject() {
            const btn = document.querySelector('button.primary');
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ Exportando...";
            
            // Usamos setTimeout para que la UI se actualice antes del bloqueo por JSON.stringify
            setTimeout(() => {
                try {
                    const projectToExport = JSON.parse(JSON.stringify(project));
                    Object.values(projectToExport.scenes).forEach(s => {
                        delete s.imgFull; 
                    });
                    const json = JSON.stringify(projectToExport);
                    
                    const s = project.settings;
                    const size = s.btnSize || 50;
                    let sizeCSS = "";
                    if (s.navStyle === 'minimal') sizeCSS = `font-size: ${size}px;`;
                    else if (s.navStyle === 'classic') sizeCSS = `width: ${size}px; height: ${size}px; font-size: ${size*0.4}px; display:flex; justify-content:center; align-items:center;`;
                    else if (s.navStyle === 'comic') sizeCSS = `font-size: ${size*0.4}px; padding: ${size*0.2}px;`;

                    // Dividimos el HTML en partes para no saturar la memoria con un String gigante
                    const htmlStart = `
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${project.meta.title}</title>
<style>
body{margin:0;background:#000;height:100vh;overflow:hidden;font-family:sans-serif;}
#app{width:100%;height:100%;display:flex;justify-content:center;align-items:center;position:relative;}
.wrapper{position:relative;width:auto;height:auto;max-width:100%;max-height:100%;line-height:0;box-shadow:0 0 50px rgba(0,0,0,0.8);}
img{display:block;width:auto;height:auto;max-width:100vw;max-height:100vh;object-fit:contain;}
.zone{position:absolute;cursor:pointer;z-index:10;-webkit-tap-highlight-color:rgba(255,255,255,0.3);}
.nav-btn{position:absolute;z-index:20;cursor:pointer;user-select:none;transition:opacity 0.3s;}
.hidden{opacity:0;pointer-events:none;}
.style-classic{background:rgba(0,0,0,0.5);border:2px solid #777;border-radius:50%;color:white;}
.style-minimal{background:transparent;color:rgba(255,255,255,0.8);text-shadow:0 2px 5px black;}
.style-comic{background:white;border:3px solid black;color:black;font-family:'Comic Sans MS',cursive;border-radius:12px;font-weight:bold;box-shadow:4px 4px 0 black;}
</style>
</head>
<body>
<div id="app"><div class="wrapper"><img id="img"><div id="zones"></div></div><div id="ui"></div></div>
<script>
const P=`;

                    const htmlEnd = `;
let hist=[];
let timer;
const elImg=document.getElementById('img');
const elZones=document.getElementById('zones');
const elUI=document.getElementById('ui');

function go(id){
    if(!P.scenes[id])return;
    if(hist[hist.length-1]!==id) hist.push(id);
    const s=P.scenes[id];
    elImg.src=s.img;
    elZones.innerHTML='';
    s.zones.forEach(z=>{
        if(z.invisible) return; 
        const d=document.createElement('div');
        d.className='zone';
        d.style.left=z.x+'%';d.style.top=z.y+'%';d.style.width=z.w+'%';d.style.height=z.h+'%';
        d.onclick=()=>go(z.targetId);
        elZones.appendChild(d);
    });
}
function back(){
    if(hist.length>1){
        hist.pop();
        const prev=hist.pop();
        go(prev);
    }
}
function next(){
    const curr=P.scenes[hist[hist.length-1]];
    if(curr.zones.length>0) go(curr.zones[0].targetId);
}

if(P.settings.showNav){
    const s=P.settings;
    const makeBtn=(txt, isRight, fn)=>{
        const b=document.createElement('div');
        b.className='nav-btn style-'+s.navStyle;
        b.innerHTML=txt;
        b.onclick=fn;
        b.style.cssText += "${sizeCSS}";
        if(s.navPos==='sides'){ b.style.top='50%'; b.style.transform='translateY(-50%)'; b.style[isRight?'right':'left']='20px'; }
        else { b.style.bottom='20px'; b.style[isRight?'right':'left']='20px'; }
        elUI.appendChild(b);
    };
    const icPrev = s.navStyle==='minimal'?'&#9664;':(s.navStyle==='comic'?'ATRAS':'&#10094;');
    const icNext = s.navStyle==='minimal'?'&#9654;':(s.navStyle==='comic'?'SIGUIENTE':'&#10095;');
    makeBtn(icPrev, false, back); makeBtn(icNext, true, next);
    if(s.autoHide>0){
        const reset=()=>{
            elUI.classList.remove('hidden'); clearTimeout(timer);
            timer=setTimeout(()=>elUI.classList.add('hidden'), s.autoHide);
        };
        document.body.onmousemove=reset; reset();
    }
}
go(P.startSceneId);
<\/script>
</body>
</html>`;
                    
                    // Crear Blob a partir de array para mejor gesti√≥n de memoria
                    const blob = new Blob([htmlStart, json, htmlEnd], {type:'text/html'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'mi_comic_ultimate.html';
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    
                    showAlert("Exportaci√≥n iniciada.");
                } catch (e) {
                    console.error(e);
                    showAlert("Error al exportar: " + e.message);
                } finally {
                    btn.innerText = originalText;
                }
            }, 100);
        }
    </script>
</body>
</html>
